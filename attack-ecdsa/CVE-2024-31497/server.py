import socket
import threading
import json
import hashlib
import random
import os
import time
from ecdsa.util import sigencode_string, sigdecode_string
from ecdsa import NIST521p, SigningKey
from ecdsa.numbertheory import inverse_mod
HOST = '0.0.0.0'
PORT = 1337
FLAG = "CTF{CVE-2024-31497_PuTTY_Bias_Nonce_Is_Dangerous}"

flag_bytes = FLAG.encode()
d = int.from_bytes(flag_bytes, byteorder='big')

curve = NIST521p
n = curve.order
G = curve.generator
public_point = d * G
vk =  public_point 


def bytes_to_long(b):
    return int.from_bytes(b, byteorder='big')

def long_to_bytes(i):
    return i.to_bytes((i.bit_length() + 7) // 8, byteorder='big')

def vulnerable_sign(message_bytes):
    """
    MÔ PHỎNG LỖI CVE-2024-31497 CỦA PUTTY
    -------------------------------------------------
    Nguyên nhân: PuTTY sử dụng bộ sinh số ngẫu nhiên trả về 512 bit (SHA-512)
    cho đường cong P-521 (cần 521 bit).
    Hệ quả: 9 bit cao nhất của nonce 'k' luôn bằng 0.
    """
    
    z_bytes = hashlib.sha512(message_bytes).digest()
    z = bytes_to_long(z_bytes)

    entropy = os.urandom(32)
    k_bytes = hashlib.sha512(long_to_bytes(d) + message_bytes + entropy).digest()
    
    k = bytes_to_long(k_bytes)
    
    if k == 0: k = 1 

    kG = k * G
    r = kG.x() % n
    
    k_inv = inverse_mod(k, n)
    s = (k_inv * (z + r * d)) % n
    
    return z, r, s

def handle_client(conn, addr):
    conn.settimeout(60) 
    try:
        banner = f"""
    ██████╗ ██╗   ██╗████████╗████████╗██╗   ██╗
    ██╔══██╗██║   ██║╚══██╔══╝╚══██╔══╝╚██╗ ██╔╝
    ██████╔╝██║   ██║   ██║      ██║    ╚████╔╝ 
    ██╔═══╝ ██║   ██║   ██║      ██║     ╚██╔╝  
    ██║     ╚██████╔╝   ██║      ██║      ██║   
    ╚═╝      ╚═════╝    ╚═╝      ╚═╝      ╚═╝   
    
   
    ==================================================
         PuTTY CVE-2024-31497 Simulation Server
         Secure ECDSA P-521 Signing Service v0.1
    ==================================================
    
    """
        conn.sendall(banner.encode())

        while True:
            menu = "\n[1] Get Public Key" \
                   "\n[2] Get Signature" \
                   "\n[3] Exit\n> "
            conn.sendall(menu.encode())
            
            choice = conn.recv(1024).decode().strip()

            if choice == '1':
                pub_data = {
                    "curve": "NIST P-521",
                    "Q_x": vk.x(),
                    "Q_y": vk.y(),
                    "order_n": int(n)
                }
                conn.sendall(f"\n{json.dumps(pub_data, indent=4)}\n".encode())

            elif choice == '2':
                random_msg = os.urandom(16).hex().encode()
                msg_hash_int, r, s = vulnerable_sign(random_msg)
                
                sig_data = {
                    "msg_hex": random_msg.decode(),
                    "msg_hash_int": msg_hash_int,
                    "r": r,
                    "s": s
                }
                conn.sendall(f"{json.dumps(sig_data)}\n".encode())

            elif choice == '3':
                conn.sendall(b"Good luck hacking!\n")
                break
            else:
                conn.sendall(b"Invalid option.\n")

    except Exception as e:
        pass
    finally:
        conn.close()

def start_server():
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server.bind((HOST, PORT))
    server.listen(10)
    
    while True:
        client, addr = server.accept()
        t = threading.Thread(target=handle_client, args=(client, addr))
        t.start()

if __name__ == "__main__":
    start_server()

